# Context Actions（OpenAI）

Context Actions は OpenAI を使った「ページ上でそのまま使える」軽量アクションです。
実行対象は以下のいずれかになります。

- 現在の **選択範囲**
- ページ本文（フォールバック）

## どこから実行できるか

### 1) ポップアップ → アクション

- 選択範囲があれば **選択範囲** を対象にします。
- 選択範囲がなければ、**直近の選択キャッシュ**（ローカル保存・fresh 判定は約30秒）にフォールバックします。
- それもなければ、**ページ本文** にフォールバックします。

### 2) 右クリック → My Browser Utils → アクション

- 選択範囲を右クリックしてメニューを開いた場合は、その選択範囲を対象にします。
- それ以外は、ページ本文を対象にします。

右クリック実行時は、結果をページ上の **オーバーレイ** で表示します（ページから離れずに作業を続けられる想定です）。

## 組み込みアクション

デフォルトのアクションは `chrome.storage.sync` に保存され、ポップアップから編集/リセットできます。

- **要約**: 日本語で要点を箇条書きにして要約します。
- **日本語に翻訳**: 自然な日本語に翻訳します。
- **カレンダー登録する**: イベント情報を抽出し、以下を提供します。
  - Google カレンダーリンク
  - `.ics` ダウンロード（生成できる場合）

## カスタムアクション

ポップアップからアクションを作成/編集できます。

### 種別

- **Text**: テキスト出力を返します。
- **Event**: イベント（構造化データ）を返し、カレンダー連携に使います。

### テンプレ変数

プロンプト内で以下の変数が使えます。

- `{{text}}`: 対象テキスト（選択範囲 or ページ本文の抜粋）
- `{{title}}`: ページタイトル
- `{{url}}`: URL
- `{{source}}`: `selection` または `page`

補足:

- `{{text}}` が含まれない場合、拡張機能側で対象テキストを末尾に自動付与します。
- `{{title}}` と `{{url}}` がどちらも含まれない場合、状況によってはメタ情報を末尾に付与します。

## Event（カレンダー）抽出フォーマット

Event アクションはモデルに JSON のみを返すよう要求し、以下のキーを扱います。

- `title`（string）
- `start`（string）
- `end`（string / optional）
- `allDay`（boolean / optional）
- `location`（string / optional）
- `description`（string / optional）

推奨する日時フォーマット:

- ISO 8601（例: `2025-01-31T19:00:00+09:00`）
- 難しければ `YYYY-MM-DD HH:mm` も許容
- 日付しか分からない場合は `YYYY-MM-DD` も許容

モデルが `start: "2025-12-16 14:00〜15:00"` のようにレンジを1つのフィールドに詰めたケースは補正しつつ、

- Google カレンダーリンク生成
- `.ics` 生成

を試みます（情報が不足している場合は失敗することがあります）。

## 関連する設定

ポップアップ → 設定:

- **OpenAI API Token**: 必須（`chrome.storage.local` に保存。同期されません）
- **Model**: `gpt-5.2`（デフォルト）。プリセット選択 + 任意のモデルID入力に対応
- **追加指示**: 出力の文体やフォーマットの好みなどを上乗せできます

## プライバシー/注意点

- OpenAI への送信は **アクションを明示的に実行した場合のみ** 発生します。
- 機密情報（認証情報/秘密鍵/個人情報など）を含むテキストに対して実行する場合は注意してください。
